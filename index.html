<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BRUHsailer</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <!-- Google tag (gtag.js) -->
  <script
    async
    src="https://www.googletagmanager.com/gtag/js?id=G-CD7NXW27XT"
  ></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag("js", new Date());

    gtag("config", "G-CD7NXW27XT");
  </script>
  <body>
    <button class="dark-mode-toggle" id="darkModeToggle">ðŸŒ“</button>
    <header>
      <h1>BRUHsailer</h1>
      <h3 class="subtitle">
        An ironman guide by So Iron BRUH and ParasailerOSRS
      </h3>
      <p class="byline">Web adaptation by kyyznn</p>
    </header>
    <nav>
      <div class="nav-content">
        <a
          href="https://docs.google.com/document/d/1CBkFM70SnrW4hJXvHM2F1fYCuBF_fRnEXnTYgRnRkAE"
          >Guide Docs</a
        >
        <div id="lastUpdated"></div>
        <a href="#" id="resetProgressBtn">Reset Progress</a>
      </div>
    </nav>
    <div class="container">
      <div class="progress-bar">
        <div class="progress" id="progressBar">
          <span class="progress-text">0%</span>
        </div>
      </div>

      <div class="utility-buttons">
        <button class="utility-btn" id="jumpToLastBtn">
          Jump to Last Completed Step
        </button>
        <button class="utility-btn" id="minimizeCompletedToggle">
          Minimize Completed
        </button>
      </div>

      <div class="filter-container">
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all">All Steps</button>
          <button class="filter-btn" data-filter="completed">
            Completed Steps
          </button>
          <button class="filter-btn" data-filter="incomplete">
            Incomplete Steps
          </button>
        </div>
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="Search steps..." />
        </div>
      </div>

      <div id="guideContent">
        <!-- Guide content will be loaded here -->
      </div>
    </div>

    <div class="save-toast" id="saveToast">Progress saved</div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        loadGuideData();
        loadFilterState();

        document
          .getElementById("resetProgressBtn")
          .addEventListener("click", function (e) {
            e.preventDefault();
            if (confirm("Are you sure you want to reset your progress?")) {
              resetProgress();
            }
          });

        document
          .getElementById("darkModeToggle")
          .addEventListener("click", function () {
            document.body.classList.toggle("dark-mode");
            const isDarkMode = document.body.classList.contains("dark-mode");
            localStorage.setItem("darkMode", isDarkMode);
          });

        if (localStorage.getItem("darkMode") === "true") {
          document.body.classList.add("dark-mode");
        } else if (localStorage.getItem("darkMode") === "false") {
          document.body.classList.remove("dark-mode");
        } else {
          if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
            document.body.classList.add("dark-mode");
          }
        }

        document
          .getElementById("jumpToLastBtn")
          .addEventListener("click", function () {
            jumpToLastCompletedStep();
          });

        document
          .getElementById("minimizeCompletedToggle")
          .addEventListener("click", function () {
            this.classList.toggle("active");

            // if (this.classList.contains("active")) {
            //   this.classList.remove("active");
            // } else {
            //   this.classList.add("active");
            // }

            saveFilterState();

            const activeFilter = document
              .querySelector(".filter-btn.active")
              .getAttribute("data-filter");
            applyCurrentFilter(activeFilter);
          });
      });

      async function loadGuideData() {
        try {
          const response = await fetch("guide_data.json");
          if (!response.ok) {
            throw new Error("Failed to load guide data");
          }

          const guideData = await response.json();
          const guideContent = document.getElementById("guideContent");

          guideContent.innerHTML = "";

          const lastUpdated = document.getElementById("lastUpdated");

          lastUpdated.innerHTML = `
      Last updated: ${guideData.updatedOn}
    `;

          guideData.chapters.forEach((chapter, chapterIndex) => {
            const chapterElement = document.createElement("div");
            chapterElement.className = "guide-chapter";

            const chapterHeader = document.createElement("h2");
            chapterHeader.className = "chapter-title";
            if (chapter.titleFormatted) {
              chapterHeader.appendChild(
                renderFormattedContent(chapter.titleFormatted)
              );
            } else {
              chapterHeader.textContent = chapter.title;
            }

            const chapterContent = document.createElement("div");
            chapterContent.className = "chapter-content";

            let chapterStepCount = 0;

            chapter.sections.forEach((section, sectionIndex) => {
              const sectionElement = document.createElement("div");
              sectionElement.className = "guide-section";

              const sectionHeader = document.createElement("div");
              sectionHeader.className = "section-header";
              sectionHeader.setAttribute(
                "data-section",
                `${chapterIndex + 1}.${sectionIndex + 1}`
              );

              const sectionId = `${chapterIndex + 1}.${sectionIndex + 1}`;

              sectionHeader.innerHTML = `
          <h2 class="section-title">${section.title}</h2>
          <span class="section-time"></span>
        `;

              const sectionContent = document.createElement("div");
              sectionContent.className = "section-content";

              section.steps.forEach((step, stepIndex) => {
                chapterStepCount++;

                const stepElement = document.createElement("div");
                stepElement.className = "step";
                stepElement.id = `step-${chapterIndex + 1}-${chapterStepCount}`;

                const stepHeader = document.createElement("div");
                stepHeader.className = "step-header";

                const timeDisplay =
                  step.metadata && step.metadata.total_time
                    ? step.metadata.total_time
                    : "";

                stepHeader.innerHTML = `
            <div class="checkbox-container">
              <input type="checkbox" class="checkbox" id="check-${
                chapterIndex + 1
              }-${chapterStepCount}">
              <span class="step-number">Step ${chapterStepCount}</span>
            </div>
            <span class="step-time">Time: ${timeDisplay}</span>
          `;

                const stepContent = document.createElement("div");
                stepContent.className = "step-content";

                const description = document.createElement("div");
                description.className = "step-description";

                if (step.content && Array.isArray(step.content)) {
                  description.appendChild(renderFormattedContent(step.content));

                  if (step.nestedContent && step.nestedContent.length > 0) {
                    step.nestedContent.forEach((nested) => {
                      const nestedElement = document.createElement("div");
                      nestedElement.className = `nested-content level-${nested.level}`;

                      if (nested.content && Array.isArray(nested.content)) {
                        nestedElement.appendChild(
                          renderFormattedContent(nested.content)
                        );
                      }

                      description.appendChild(nestedElement);
                    });
                  }
                }

                stepContent.appendChild(description);

                if (step.metadata && Object.keys(step.metadata).length > 0) {
                  const metaContainer = document.createElement("div");
                  metaContainer.className = "step-meta";

                  const metadata = step.metadata;

                  for (const key in metadata) {
                    if (key === "total_time") continue;
                    if (key === "skills_quests_met") continue;

                    let displayName;
                    if (key === "gp_stack") {
                      displayName = "GP Stack";
                    } else if (key === "items_needed") {
                      displayName = "Items Needed";
                    } else {
                      displayName = key
                        .replace(/_/g, " ")
                        .replace(/\b\w/g, (l) => l.toUpperCase());
                    }

                    const metaItem = document.createElement("div");
                    metaItem.className = "meta-item";

                    const metaValue = metadata[key];

                    metaItem.innerHTML = `
                <strong>${displayName}:</strong>
                <span>${metaValue}</span>
              `;
                    metaContainer.appendChild(metaItem);
                  }

                  if (metaContainer.children.length > 0) {
                    stepContent.appendChild(metaContainer);
                  }
                }

                stepElement.appendChild(stepHeader);
                stepElement.appendChild(stepContent);
                sectionContent.appendChild(stepElement);
              });

              sectionElement.appendChild(sectionHeader);
              sectionElement.appendChild(sectionContent);
              chapterContent.appendChild(sectionElement);
            });

            if (chapter.footnotes && chapter.footnotes.length > 0) {
              const footnotesSection = document.createElement("div");
              footnotesSection.className = "guide-section footnotes-section";

              const footnotesHeader = document.createElement("div");
              footnotesHeader.className = "section-header footnotes-header";
              footnotesHeader.innerHTML = `
    <h2 class="section-title">End of chapter notes</h2>
  `;

              const footnotesContent = document.createElement("div");
              footnotesContent.className = "section-content footnotes-content";

              chapter.footnotes.forEach((footnote, footnoteIndex) => {
                if (footnote.content && Array.isArray(footnote.content)) {
                  footnotesContent.appendChild(
                    renderFormattedContent(footnote.content)
                  );
                }
              });

              footnotesSection.appendChild(footnotesHeader);
              footnotesSection.appendChild(footnotesContent);
              chapterContent.appendChild(footnotesSection);
            }

            chapterElement.appendChild(chapterHeader);
            chapterElement.appendChild(chapterContent);
            guideContent.appendChild(chapterElement);
          });

          attachEventListeners();
          loadProgress();
          updateProgress();

          const activeFilter = document
            .querySelector(".filter-btn.active")
            .getAttribute("data-filter");
          applyCurrentFilter(activeFilter);
        } catch (error) {
          console.error("Error loading guide data:", error);
          document.getElementById("guideContent").innerHTML = `
      <div class="error-message">
        <p>Failed to load guide data. Please try refreshing the page.</p>
        <p>Error: ${error.message}</p>
      </div>
    `;
        }
      }

      function renderFormattedContent(contentArray) {
        const container = document.createElement("div");

        contentArray.forEach((item) => {
          if (item.url && item.isLink) {
            const link = document.createElement("a");
            link.href = item.url;
            link.textContent = item.text;
            link.target = "_blank";
            link.className = "drive-link";
            applyFormatting(link, item.formatting);
            container.appendChild(link);
          } else if (
            item.formatting &&
            item.formatting.url &&
            item.formatting.isLink
          ) {
            const link = document.createElement("a");
            link.href = item.formatting.url;
            link.textContent = item.text;
            link.target = "_blank";
            link.className = "drive-link";
            applyFormatting(link, item.formatting);
            container.appendChild(link);
          } else if (/(https?:\/\/[^\s]+)/g.test(item.text)) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urlMatches = item.text.match(urlRegex);
            let remainingText = item.text;

            urlMatches.forEach((url) => {
              const parts = remainingText.split(url);

              if (parts[0]) {
                const textSpan = document.createElement("span");
                textSpan.textContent = parts[0];
                applyFormatting(textSpan, item.formatting);
                container.appendChild(textSpan);
              }

              const link = document.createElement("a");
              link.href = url;
              link.textContent = url;
              link.target = "_blank";
              applyFormatting(link, item.formatting);
              container.appendChild(link);

              remainingText = parts.slice(1).join(url);
            });

            if (remainingText) {
              const textSpan = document.createElement("span");
              textSpan.textContent = remainingText;
              applyFormatting(textSpan, item.formatting);
              container.appendChild(textSpan);
            }
          } else {
            const span = document.createElement("span");
            span.textContent = item.text;
            applyFormatting(span, item.formatting);
            container.appendChild(span);
          }
        });

        return container;
      }

      function applyFormatting(element, formatting) {
        if (!formatting) return;

        if (formatting.bold) {
          element.style.fontWeight = "bold";
        } else {
          element.style.fontWeight = "normal";
        }

        if (formatting.italic) element.style.fontStyle = "italic";
        else {
          element.style.fontStyle = "normal";
        }

        let textDecoration = "";
        if (formatting.underline) textDecoration += "underline ";
        if (formatting.strikethrough) textDecoration += "line-through ";

        if (textDecoration) {
          element.style.textDecoration = textDecoration.trim();
        } else {
          element.style.textDecoration = "none";
        }

        if (formatting.fontSize) {
          element.style.fontSize = `${formatting.fontSize + 2}px`;
        }

        if (formatting.fontFamily) {
          element.style.fontFamily = formatting.fontFamily;
        }

        if (formatting.color) {
          const color = formatting.color;
          if (
            color.r !== undefined &&
            color.g !== undefined &&
            color.b !== undefined
          ) {
            element.style.color = `rgb(${Math.round(
              color.r * 255
            )}, ${Math.round(color.g * 255)}, ${Math.round(color.b * 255)})`;
          }
        }
      }

      function attachEventListeners() {
        document.querySelectorAll(".section-header").forEach((header) => {
          header.addEventListener("click", function () {
            const content = this.nextElementSibling;
            content.classList.toggle("active");
            this.classList.toggle("active");
          });
        });

        document.querySelectorAll(".chapter-title").forEach((header) => {
          header.addEventListener("click", function () {
            const content = this.nextElementSibling;
            content.classList.toggle("active");
            this.classList.toggle("active");
          });
        });

        document.querySelectorAll(".checkbox").forEach((checkbox) => {
          checkbox.addEventListener("change", function () {
            const stepId = this.id.replace("check-", "");
            const stepElement = document.getElementById(`step-${stepId}`);

            if (this.checked) {
              stepElement.classList.add("completed");

              const isMinimized = document
                .getElementById("minimizeCompletedToggle")
                .classList.contains("active");

              if (isMinimized) {
                const stepContent = stepElement.querySelector(".step-content");
                if (stepContent) {
                  stepContent.style.display = "none";
                }
              }
            } else {
              stepElement.classList.remove("completed");

              const stepContent = stepElement.querySelector(".step-content");
              if (stepContent) {
                stepContent.style.display = "block";
              }
            }

            saveProgress();
            updateProgress();

            const activeFilter = document
              .querySelector(".filter-btn.active")
              .getAttribute("data-filter");
            applyCurrentFilter(activeFilter);
          });
        });

        document.querySelectorAll(".step-header").forEach((header) => {
          header.addEventListener("click", function (e) {
            if (e.target.type !== "checkbox") {
              const checkbox = this.querySelector(".checkbox");
              checkbox.checked = !checkbox.checked;

              const changeEvent = new Event("change");
              checkbox.dispatchEvent(changeEvent);
            }
          });
        });

        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            document.querySelectorAll(".filter-btn").forEach((b) => {
              b.classList.remove("active");
            });
            this.classList.add("active");

            const filter = this.getAttribute("data-filter");
            applyCurrentFilter(filter);
          });
        });

        const searchInput = document.getElementById("searchInput");
        searchInput.addEventListener("input", function () {
          const searchTerm = this.value.toLowerCase();
          const steps = document.querySelectorAll(".step");

          steps.forEach((step) => {
            const content = step
              .querySelector(".step-description")
              .textContent.toLowerCase();
            const isVisible = content.includes(searchTerm);
            step.style.display = isVisible ? "block" : "none";
          });

          document.querySelectorAll(".guide-section").forEach((section) => {
            const visibleSteps = Array.from(
              section.querySelectorAll(".step")
            ).some((step) => step.style.display !== "none");

            if (visibleSteps) {
              section.style.display = "block";
              section.querySelector(".section-content").classList.add("active");
              section.querySelector(".section-header").classList.add("active");
            } else {
              section.style.display = "none";
            }
          });
        });
      }

      function saveProgress() {
        const progress = {};
        document.querySelectorAll(".checkbox").forEach((checkbox) => {
          progress[checkbox.id] = checkbox.checked;
        });
        localStorage.setItem("guideProgress", JSON.stringify(progress));
        showSaveToast();
      }

      function loadProgress() {
        const savedProgress = localStorage.getItem("guideProgress");
        if (savedProgress) {
          const progress = JSON.parse(savedProgress);
          for (const id in progress) {
            const checkbox = document.getElementById(id);
            if (checkbox) {
              checkbox.checked = progress[id];
              if (progress[id]) {
                const stepId = id.replace("check-", "");
                const stepElement = document.getElementById(`step-${stepId}`);
                if (stepElement) {
                  stepElement.classList.add("completed");
                }
              }
            }
          }
        }
      }

      function resetProgress() {
        localStorage.removeItem("guideProgress");
        document.querySelectorAll(".checkbox").forEach((checkbox) => {
          checkbox.checked = false;
        });
        document.querySelectorAll(".step").forEach((step) => {
          step.classList.remove("completed");
        });
        updateProgress();
        showSaveToast("Progress reset");
      }

      function updateProgress() {
        const totalSteps = document.querySelectorAll(".checkbox").length;
        const completedSteps =
          document.querySelectorAll(".checkbox:checked").length;
        const progressPercent = Math.round((completedSteps / totalSteps) * 100);

        const progressBar = document.getElementById("progressBar");
        progressBar.style.width = `${progressPercent}%`;
        progressBar.querySelector(
          ".progress-text"
        ).textContent = `${progressPercent}%`;

        highlightLastCompletedStep();
      }

      function showSaveToast(message = "Progress saved") {
        const toast = document.getElementById("saveToast");
        toast.textContent = message;
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 2000);
      }

      function jumpToLastCompletedStep() {
        const completedSteps = document.querySelectorAll(".step.completed");
        if (completedSteps.length > 0) {
          const lastCompletedStep = completedSteps[completedSteps.length - 1];

          const chapterContent = lastCompletedStep.closest(".chapter-content");
          if (chapterContent) {
            chapterContent.classList.add("active");
            const chapterHeader = chapterContent.previousElementSibling;
            if (chapterHeader) {
              chapterHeader.classList.add("active");
            }
          }
          const sectionContent = lastCompletedStep.closest(".section-content");
          if (sectionContent) {
            sectionContent.classList.add("active");
            const sectionHeader = sectionContent.previousElementSibling;
            if (sectionHeader) {
              sectionHeader.classList.add("active");
            }
          }

          setTimeout(() => {
            lastCompletedStep.scrollIntoView({ behavior: "smooth" });
          }, 100);
        }
      }

      function highlightLastCompletedStep() {
        document.querySelectorAll(".step.highlight").forEach((step) => {
          step.classList.remove("highlight");
        });

        const completedSteps = document.querySelectorAll(".step.completed");
        if (completedSteps.length > 0) {
          const lastCompletedStep = completedSteps[completedSteps.length - 1];
          lastCompletedStep.classList.add("highlight");
        }
      }

      function loadFilterState() {
        const savedFilter = localStorage.getItem("guideFilter");
        if (savedFilter) {
          const { filter, minimized } = JSON.parse(savedFilter);

          document.querySelectorAll(".filter-btn").forEach((btn) => {
            if (btn.getAttribute("data-filter") === filter) {
              btn.classList.add("active");
            } else {
              btn.classList.remove("active");
            }
          });

          if (minimized) {
            document
              .getElementById("minimizeCompletedToggle")
              .classList.add("active");
          } else {
            document
              .getElementById("minimizeCompletedToggle")
              .classList.remove("active");
          }

          applyCurrentFilter(filter);
        }
      }

      function saveFilterState() {
        const filter = document
          .querySelector(".filter-btn.active")
          .getAttribute("data-filter");
        const isMinimized = document
          .getElementById("minimizeCompletedToggle")
          .classList.contains("active");
        localStorage.setItem(
          "guideFilter",
          JSON.stringify({ filter: filter, minimized: isMinimized })
        );
      }

      function applyCurrentFilter(filter) {
        if (!filter) {
          filter = document
            .querySelector(".filter-btn.active")
            .getAttribute("data-filter");
        }

        const steps = document.querySelectorAll(".step");
        const lastCompletedStep = document.querySelector(".step.highlight");
        const isMinimized = document
          .getElementById("minimizeCompletedToggle")
          .classList.contains("active");
        const sections = document.querySelectorAll(".guide-section");
        const chapters = document.querySelectorAll(".guide-chapter");

        if (lastCompletedStep) {
          lastCompletedStep.style.display = "block";
          const parentSection = lastCompletedStep.closest(".guide-section");
          const parentChapter = lastCompletedStep.closest(".guide-chapter");
          if (parentSection) {
            parentSection.style.display = "block";
            parentSection
              .querySelector(".section-content")
              .classList.add("active");
            parentSection
              .querySelector(".section-header")
              .classList.add("active");
          }
          if (parentChapter) {
            parentChapter.style.display = "block";
            parentChapter
              .querySelector(".chapter-content")
              .classList.add("active");
          }
        }

        steps.forEach((step) => {
          if (step === lastCompletedStep) return;

          const isCompleted = step.classList.contains("completed");

          if (filter === "all") {
            step.style.display = "block";
          } else if (filter === "completed") {
            step.style.display = isCompleted ? "block" : "none";
          } else if (filter === "incomplete") {
            step.style.display = !isCompleted ? "block" : "none";
          }
        });

        steps.forEach((step) => {
          const stepContent = step.querySelector(".step-content");
          const isCompleted = step.classList.contains("completed");

          if (stepContent) {
            if (isMinimized && isCompleted) {
              stepContent.style.display = "none";
            } else {
              stepContent.style.display = "block";
            }
          }
        });

        sections.forEach((section) => {
          if (lastCompletedStep && section.contains(lastCompletedStep)) return;

          const sectionSteps = section.querySelectorAll(".step");
          const visibleSteps = Array.from(sectionSteps).filter(
            (step) => step.style.display !== "none"
          );
          const allStepsCompleted = Array.from(sectionSteps).every((step) =>
            step.classList.contains("completed")
          );

          if (section.classList.contains("footnotes-section")) {
            section.style.display = "block";
          } else {
            if (filter === "incomplete" && allStepsCompleted) {
              section.style.display = "none";
            } else {
              section.style.display =
                visibleSteps.length > 0 ? "block" : "none";
            }
          }
        });

        chapters.forEach((chapter) => {
          if (lastCompletedStep && chapter.contains(lastCompletedStep)) return;

          const chapterSections = Array.from(
            chapter.querySelectorAll(".guide-section")
          ).filter(
            (section) => !section.classList.contains("footnotes-section")
          );

          const visibleSections = chapterSections.filter(
            (section) => section.style.display !== "none"
          );

          chapter.style.display = visibleSections.length > 0 ? "block" : "none";
        });

        saveFilterState();
      }
    </script>
  </body>
</html>
